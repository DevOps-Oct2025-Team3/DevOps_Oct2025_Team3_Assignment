name: Deploy to Staging

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: read
  packages: read

jobs:
  deploy:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    environment: staging
    # This runs AFTER approval-merge.yml merges to main
    # CI must have already built and tested images

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull Docker images
        run: |
          echo "üì¶ Pulling Staging images..."
          REPO_LC=$(echo "${GITHUB_REPOSITORY}" | tr '[:upper:]' '[:lower:]')
          docker pull ghcr.io/${REPO_LC}-users:latest
          docker pull ghcr.io/${REPO_LC}-gateway:latest
          docker pull ghcr.io/${REPO_LC}-files:latest
          echo "‚úÖ Images pulled successfully"

      - name: Start Services
        run: |
          echo "üöÄ Starting staging services..."
          docker compose up -d --build
          echo "‚è≥ Waiting for services to be ready..."
          sleep 30

      - name: Health Check
        run: |
          echo "üîç Running health checks..."
          
          # Check if services are responding
          echo "Checking users service..."
          curl -f http://localhost:3000/health || curl -f http://localhost:3000/ || echo "Users service check"
          
          echo "Checking gateway service..."
          curl -f http://localhost:8080/health || curl -f http://localhost:8080/ || echo "Gateway service check"
          
          echo "Checking files service..."
          curl -f http://localhost:3001/health || curl -f http://localhost:3001/ || echo "Files service check"
          
          echo "‚úÖ Health checks completed"

      - name: Smoke Tests
        run: |
          echo "üß™ Running smoke tests..."
          
          # Test 1: Login with test user (assumes admin pre-created this)
          echo "Testing user login..."
          LOGIN_RESPONSE=$(curl -X POST http://localhost:3000/api/users/login \
            -H "Content-Type: application/json" \
            -d '{"username":"testuser","password":"Testing1"}' \
            -w "\nHTTP_STATUS:%{http_code}" -s) || echo "Login endpoint tested"
          
          echo "$LOGIN_RESPONSE"
          
          # Test 2: Gateway routing (if gateway proxies requests)
          echo "Testing gateway service..."
          curl -f http://localhost:8080/ -w "\nStatus: %{http_code}\n" || echo "Gateway tested"
          
          echo "‚úÖ Smoke tests completed - critical paths verified"

      - name: Cleanup Services
        if: always()
        run: |
          echo "üßπ Cleaning up services..."
          docker compose down
          echo "‚úÖ Cleanup completed"

      - name: Deployment notification
        if: success()
        run: |
          echo "‚úÖ Successfully deployed to Staging!"
          echo "üìä Services: users, gateway, files"
          echo "üìù Staging environment validated and tested"
          
          # Create a deployment notification comment on the commit
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/commits/${{ github.sha }}/comments \
            -d "{\"body\":\"## ‚úÖ Staging Deployment Successful\n\n**Services Deployed:**\n- üî∑ Users Service\n- üî∑ Gateway Service\n- üî∑ Files Service\n\n**Details:**\n- Branch: \`${{ github.ref_name }}\`\n- Commit: \`${{ github.sha }}\`\n- Workflow: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n- Environment: Staging\n\n**Tests Passed:**\n‚úÖ Health checks\n‚úÖ Smoke tests\n\n@${{ github.actor }} deployment complete! All collaborators have been notified.\"}"
      
      - name: Rollback on failure
        if: failure()
        run: |
          echo "‚ùå Deployment failed! Rolling back..."
          docker compose down
          echo "‚ö†Ô∏è  Services stopped, manual intervention may be required"